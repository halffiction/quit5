<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸ˆì—° 5ë¶„ ì „í™˜ (PWA)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16a34a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ê¸ˆì—° 5ë¶„ ì „í™˜">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="assets/icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="assets/icons/icon-512.png">
  <style>
    :root{--bg:#f8f8f6;--panel:#fff;--text:#222;--muted:#6b7280;--brand:#16a34a;}
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Pretendard,Roboto,sans-serif}
    .wrap{max-width:720px;margin:0 auto;padding:20px 16px 32px}
    .card{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.04);padding:20px}
    h1{font-size:24px;margin:0 0 8px;font-weight:800}
    .subtitle{color:var(--muted);margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 14px;font-size:16px}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#84cc16)}
    .stage{border:1px dashed #e5e7eb;border-radius:14px;padding:12px 14px;background:#fcfcfd}
    .stage.active{border-style:solid;border-color:#22c55e;background:#f5fff7}
    .stage .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .stage .time{font-feature-settings:"tnum";font-variant-numeric:tabular-nums;color:#111;font-weight:600}
    .muted{color:#6b7280}
    .pill{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:8px 12px;font-size:14px;display:inline-block;margin-right:8px;margin-bottom:8px}
    .hint{font-size:14px;color:#4b5563;margin-top:10px}
    .footer{margin-top:20px;color:#94a3b8;font-size:12px;text-align:center}
    .success{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:12px;border-radius:10px}
    .danger{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d;padding:12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸš­ ê¸ˆì—° 5ë¶„ ì „í™˜</h1>
      <div class="subtitle">ë‹´ë°°ê°€ ìƒê°ë‚  ë•Œ, 5ë¶„ë§Œ í•¨ê»˜í•´ìš”. (PWA: í™ˆ í™”ë©´ ì¶”ê°€ & ì˜¤í”„ë¼ì¸)</div>

      <div>
        <span class="pill">ì˜¤ëŠ˜ ì„±ê³µ: <b id="stat-today">0</b>íšŒ</span>
        <span class="pill">ëˆ„ì  ì„±ê³µ: <b id="stat-total">0</b>íšŒ</span>
        <span class="pill">ì—°ì† ì¼ìˆ˜: <b id="stat-streak">0</b>ì¼</span>
        <span class="pill">ì ˆì•½ ì‹œê°„: <b id="stat-mins">0</b>ë¶„</span>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="primary" id="btn-start">ì§€ê¸ˆ 5ë¶„ ì‹œì‘</button>
        <button id="btn-new">ìƒˆ ë¯¸ì…˜ ì¡°í•©</button>
        <button id="btn-reset">ê¸°ë¡ ì´ˆê¸°í™”</button>
        <button id="btn-install" style="display:none">í™ˆ í™”ë©´ì— ì¶”ê°€</button>
      </div>

      <div style="height:16px"></div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="hint">ë‹¨ê³„ê°€ ë°”ë€” ë•Œ ê°€ë³ê²Œ ì†Œë¦¬/ì§„ë™ ì•Œë¦¼. (iOS ì¼ë¶€ ê¸°ì¢…ì€ ì§„ë™ ì œí•œ)</div>

      <div style="height:14px"></div>
      <div id="stages" class="grid"></div>
      <div style="height:14px"></div>
      <div id="message"></div>

      <div class="footer">
        v1.0 PWA â€¢ ì˜¤í”„ë¼ì¸ ì‚¬ìš© ê°€ëŠ¥ â€¢ í™ˆ í™”ë©´ì— ì¶”ê°€ë¡œ ì•±ì²˜ëŸ¼ ì‹¤í–‰
      </div>
    </div>
  </div>

  <audio id="ding" preload="auto">
    <source src="data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YVgAAACAgICAgP8AAP//gICAf39/f4CAgP///4CAgH9/f3+AgID///+AgIB/f39/gICA////gICAf39/f4CAgP///4CAgH9/f3+AgID///8=" type="audio/wav">
  </audio>

  <script>
  // PWA install + SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }
  let deferredPrompt;
  const installBtn = document.getElementById('btn-install');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block';
  });
  installBtn?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.style.display='none'; deferredPrompt=null; });

  // Missions
  const MISSION_POOL = [
    {cat:"ì‹ ì²´",  text:"ë¬¼ í•œ ì»µì„ ì„¸ ë²ˆì— ë‚˜ëˆ  ë§ˆì…”ìš”.", t:60},
    {cat:"ì¸ì§€",  text:"ë¨¸ë¦¬ë¡œë§Œ ë§ì…ˆ 3ê°œ: 12+8, 25+17, 43+29.", t:45},
    {cat:"í˜¸í¡",  text:"ëˆˆì„ ê°ê³  ì‹¬í˜¸í¡ 10ì´ˆ Ã— 3íšŒ.", t:30},
    {cat:"ì •ì„œ",  text:"ì‚¬ì§„ì²©ì—ì„œ ë¯¸ì†Œ ì§“ê²Œ í•˜ëŠ” ì‚¬ì§„ 1ì¥ ë³´ê¸°.", t:45},
    {cat:"ì‹ ì²´",  text:"ì†ë°”ë‹¥ ì§€ì•• 30ì´ˆ. â€œì§€ê¸ˆ ê´œì°®ì•„.â€ ì†ì‚­ì´ê¸°.", t:30},
    {cat:"ì¸ì§€",  text:"ì˜¤ëŠ˜ ê°ì‚¬í•œ ì¼ 3ê°€ì§€ë¥¼ ì†ìœ¼ë¡œ ì²œì²œíˆ ë– ì˜¬ë¦¬ê¸°.", t:45},
    {cat:"ê°ê°",  text:"ì°½ë°–ì„ ë°”ë¼ë³´ë©° 4ê°€ì§€ ìƒ‰ì„ ì°¾ì•„ ì´ë¦„ ë¶™ì´ê¸°.", t:45},
    {cat:"í˜¸í¡",  text:"5-5 í˜¸í¡: 5ì´ˆ ë“¤ì´ë§ˆì‹œê³  5ì´ˆ ë‚´ì‰¬ê¸° Ã— 3íšŒ.", t:30},
    {cat:"ì •ì„œ",  text:"ì–‘ì†ìœ¼ë¡œ ì–´ê¹¨ í† ë‹¥ì´ë©° 30ì´ˆê°„ ëª¸ì˜ ì˜¨ê¸° ëŠë¼ê¸°.", t:30},
  ];
  const TOTAL_SECONDS = 300;
  let stages=[], current=-1, left=0, timer=null, totalElapsed=0;
  const $=(s)=>document.querySelector(s), ding=document.getElementById('ding');

  function vibrate(ms=120){ if (navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }
  function beep(){ try{ ding.currentTime=0; ding.play(); }catch{} }

  function pickStages(){
    const pool=[...MISSION_POOL], chosen=[];
    while(chosen.length<4 && pool.length){ const i=Math.floor(Math.random()*pool.length); chosen.push(pool.splice(i,1)[0]); }
    const used=chosen.reduce((s,m)=>s+m.t,0);
    const last={cat:"ì •ë¦¬", text:"ë§ˆë¬´ë¦¬: ì¡°ìš©íˆ ì•‰ì•„ ë§ˆìŒì— 'ê³ ë§ˆì›€'ì„ 1ë¶„ê°„ ë– ì˜¬ë¦¬ê¸°.", t:Math.max(30, TOTAL_SECONDS-used)};
    stages=[...chosen,last]; renderStages();
  }
  function renderStages(){
    const wrap=$("#stages"); wrap.innerHTML="";
    stages.forEach((m,idx)=>{
      const el=document.createElement('div');
      el.className="stage"+(idx===current?" active":"");
      el.innerHTML=`<div class="top"><div><b>${idx+1}ë‹¨ê³„</b> Â· <span class="muted">${m.cat}</span></div><div class="time" id="time-${idx}">${fmt(m.t)}</div></div><div>${m.text}</div>`;
      wrap.appendChild(el);
    }); updateBar();
  }
  function fmt(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(1,"0")}:${String(r).padStart(2,"0")}`; }
  function updateBar(){ const total=stages.reduce((s,m)=>s+m.t,0); const w=Math.min(100, Math.round((totalElapsed/total)*100)); $("#bar").style.width=w+"%"; }

  function tick(){
    if (left<=0){ current++; if (current>=stages.length){ stop(true); return; } left=stages[current].t; renderStages(); vibrate(); beep(); }
    left--; totalElapsed++; const el=document.getElementById("time-"+current); if (el) el.textContent=fmt(Math.max(0,left)); updateBar();
  }
  function start(){ resetSessionUI(); current=-1; left=0; totalElapsed=0; $("#message").innerHTML=""; timer && clearInterval(timer); tick(); timer=setInterval(tick,1000); $("#btn-start").disabled=true; }
  function stop(success){ timer && clearInterval(timer); timer=null; $("#btn-start").disabled=false; $("#message").innerHTML = success? `<div class="success">âœ… ì˜ í•´ë‚´ì…¨ì–´ìš”! 5ë¶„ì„ ì´ê²¨ëƒˆìŠµë‹ˆë‹¤.</div>` : `<div class="danger">â¹ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•´ë³¼ê¹Œìš”?</div>`; if(success) addSuccess(); }
  function resetSessionUI(){ renderStages(); $("#bar").style.width="0%"; }
  function addSuccess(){
    const todayKey="quit5_today", totalKey="quit5_total", minsKey="quit5_mins", streakKey="quit5_streak", lastDayKey="quit5_lastday";
    const today=new Date().toISOString().slice(0,10), last=localStorage.getItem(lastDayKey);
    localStorage.setItem(todayKey, String(Number(localStorage.getItem(todayKey)||0)+1));
    localStorage.setItem(totalKey, String(Number(localStorage.getItem(totalKey)||0)+1));
    localStorage.setItem(minsKey,  String(Number(localStorage.getItem(minsKey)||0)+5));
    let streak=Number(localStorage.getItem(streakKey)||0);
    if (!last) streak=1; else { const diff=(new Date(today)-new Date(last))/(1000*60*60*24); if (diff===1) streak+=1; else if (diff>1) streak=1; }
    localStorage.setItem(streakKey,String(streak)); localStorage.setItem(lastDayKey,today); refreshStats();
  }
  function refreshStats(){
    $("#stat-today").textContent = localStorage.getItem("quit5_today") || "0";
    $("#stat-total").textContent = localStorage.getItem("quit5_total") || "0";
    $("#stat-mins").textContent  = localStorage.getItem("quit5_mins")  || "0";
    $("#stat-streak").textContent= localStorage.getItem("quit5_streak")|| "0";
  }
  function resetStats(){ if (!confirm("ê¸°ë¡ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return; ["quit5_today","quit5_total","quit5_mins","quit5_streak","quit5_lastday"].forEach(k=>localStorage.removeItem(k)); refreshStats(); }

  pickStages(); refreshStats();
  document.getElementById('btn-start').addEventListener('click', start);
  document.getElementById('btn-new').addEventListener('click', ()=>{ if (timer) { alert("ì§„í–‰ ì¤‘ì—ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ì–´ìš”."); return;} pickStages(); });
  document.getElementById('btn-reset').addEventListener('click', resetStats);
  window.addEventListener('beforeunload', ()=>{ if (timer){ stop(false); } });
  </script>
</body>
</html>
